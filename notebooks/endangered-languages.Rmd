```{r}
library(tidyverse)
```

```{r}
UNESCO <- read_csv('../data/UNESCO-2011.csv')
```

```{r}
UN <- read_csv('../data/UN-data.csv')
```
```{r}
UN <- UN %>% 
  filter(Year == 2010)
```


```{r}
UNESCO <- UNESCO %>% 
  mutate(Country = strsplit(Country, ",")) %>% 
  unnest(Country)
```

```{r}
GDP <-
  UN %>% 
  filter(topic == 'GDP per capita (US dollars)' & Series == 'GDP per capita (US dollars)') %>%
  select(Country, country_GDP_per_capita_US_dollars = Value)
```

```{r}
RD <-
  UN %>% 
  filter(topic == 'domestic expenditure in RD' & Series == 'Gross domestic expenditure on R & D: as a percentage of GDP (%)') %>% 
  select(Country, country_RD_exp_as_GDP_percentage = Value)
```

```{r}
CO2 <-
  UN %>% 
  filter(topic == 'CO2 emission' & Series == 'Emissions per capita (metric tons of carbon dioxide)')%>% 
  select(Country, country_CO2_tons_per_capita = Value)
```

```{r}
species <-
  UN %>% 
  filter(topic == 'threatened species' & Series == 'Threatened Species: Total (number)')%>% 
  select(Country, country_threatened_species_total_num = Value)
```

```{r}
education <-
  UN %>% 
  filter(topic == 'expenditure on edu' & Series == 'Public expenditure on education (% of GDP)')%>% 
  select(Country, country_edu_exp_as_GDP_percentage = Value)
```

```{r}
health <-
  UN %>% 
  filter(topic == 'expenditure on health' & Series == 'Current health expenditure (% of GDP)')%>% 
  select(Country, country_health_exp_as_GDP_percentage = Value)
```

```{r}
internet <-
  UN %>% 
  filter(topic == 'internet usage' & Series == 'Percentage of individuals using the internet')%>% 
  select(Country, country_individuals_using_internet_percentage = Value)
```

```{r}
land <-
  UN %>% 
  filter(topic == 'land' & Series == 'Land area (thousand hectares)')%>% 
  select(Country, country_land_area_thousand_hectars = Value)
```

```{r}
migrants <-
  UN %>% 
  filter(topic == 'migrants' & Series == 'International migrant stock: Both sexes (% total population)')%>% 
  select(Country, country_international_migrants_population_percentage = Value)

```

```{r}
tourism <-
  UN %>% 
  filter(topic == 'tourism' & Series == 'Tourist/visitor arrivals (thousands)')%>% 
  select(Country, country_tourists_thousand = Value)
```

```{r}
population <-
  UN %>% 
  filter(topic == 'population' & Series == 'Population mid-year estimates (millions)')%>% 
  select(Country, country_population_millions = Value)
```

```{r}
UN_combined <-
  full_join(GDP, RD) %>% 
  full_join(CO2) %>% 
  full_join(species) %>% 
  full_join(education) %>% 
  full_join(health) %>% 
  full_join(internet) %>% 
  full_join(land) %>% 
  full_join(migrants) %>% 
  full_join(tourism) %>% 
  full_join(population) 
#, CO2, species, education, health, internet, land, migrants, tourism, population)

```


```{r}
write.csv(UN_UNESCO,'../data/UN_UNESCO.csv')
```

```{r}
UN_UNESCO <- right_join(UN_combined, UNESCO, on = 'Country')
```
```{r}
UN_UNESCO <- 
  rename(UN_UNESCO, c('location_description' = 'Description of the location', 
                      'english_name' = 'Name in English',
                      'french_name' = 'Name in French',
                      'spanish_name' = 'Name in Spanish',
                      'ISO639-3_codes' = 'ISO639-3 codes',
                      'endangerment_degree' = 'Degree of endangerment', 
                      'alternate_names' = 'Alternate names', 
                      'name_in_the_language' = 'Name in the language', 
                      'number_of_speakers' = 'Number of speakers'))

```


```{r}
library(sf)
library(leaflet)
library(htmltools)
```

```{r}
UN_UNESCO <- UN_UNESCO %>%
  mutate(endangerment_degree = factor(endangerment_degree, 
                                      levels = c("Vulnerable",
                                                 "Definitely endangered",
                                                 "Severely endangered", 
                                                 "Critically endangered",
                                                 "Extinct")))
```


```{r}
pal <- colorFactor(palette = c('navajowhite2', 'yellow', 'orange', 'red', 'black'), 
                   levels = c("Vulnerable",
                              "Definitely endangered",
                              "Severely endangered", 
                              "Critically endangered",
                              "Extinct"))


popup <- paste("<b>English name:</b>", UN_UNESCO$english_name,"<br>",
               "<b>French name:</b>", UN_UNESCO$french_name,"<br>",
               "<b>Spanish name:</b>", UN_UNESCO$spanish_name, "<br>",
               
               "<b>ISO639-3 code:</b>", UN_UNESCO$`ISO639-3_codes`,"<br>",
               "<b>Alternate name:</b>", UN_UNESCO$alternate_names,"<br>",
               "<b>Endangerment degree:</b>", UN_UNESCO$endangerment_degree,"<br>",
               "<b>Number of speakers:</b>", UN_UNESCO$number_of_speakers,"<br>",
               "<b>Country:</b>", UN_UNESCO$Country,"<br>",
               
               "<b>Specific location(s):</b>",  UN_UNESCO$location_description,"<br>"
)



leaflet() %>% 
  addProviderTiles(provider = "Esri") %>% 
  
  addCircleMarkers(data = UN_UNESCO, radius = log10(UN_UNESCO$number_of_speakers), opacity = .6, color = pal(UN_UNESCO$endangerment_degree),
                   lng = ~Longitude, 
                   lat = ~Latitude,
                   popup = popup) %>% 
  addLegend(pal= pal, position = 'bottomright', values = factor(UN_UNESCO$endangerment_degree), title = 'Endangerment degree' 
  )
```


```{r}
UN_UNESCO %>% 
  group_by(endangerment_degree) %>% 
  count() %>% 
  arrange(desc(n))'
```



```{r}
UN_UNESCO %>% 
  ggplot(aes(x = endangerment_degree, y = country_threatened_species_total_num)) + 
  geom_boxplot()
```




```{r}
a<- UN_UNESCO %>% 
  ggplot(aes(fill = as_factor(country_GDP_per_capita_US_dollars), x = endangerment_degree)) +
  geom_bar(position='fill') +
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE))
ggplotly(a)
```


